import{c as S,l as y}from"./chunk-Y7MSNO74.js";import{B as m,C as _,F as H,Qa as R}from"./chunk-XYURQZTM.js";import{G as l,Hc as i,M as b,U as h,X as k,aa as I,ba as g,s as u,t as v,w as d,xa as c}from"./chunk-LW3WOUBG.js";var a=class extends Error{};a.prototype.name="InvalidTokenError";function A(e){return decodeURIComponent(atob(e).replace(/(.)/g,(t,r)=>{let o=r.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o}))}function x(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return A(t)}catch{return atob(t)}}function U(e,t){if(typeof e!="string")throw new a("Invalid token specified: must be a string");t||(t={});let r=t.header===!0?0:1,o=e.split(".")[r];if(typeof o!="string")throw new a(`Invalid token specified: missing part #${r+1}`);let n;try{n=x(o)}catch(s){throw new a(`Invalid token specified: invalid base64 for part #${r+1} (${s.message})`)}try{return JSON.parse(n)}catch(s){throw new a(`Invalid token specified: invalid json for part #${r+1} (${s.message})`)}}var f=new m(()=>!0),L=new m(()=>!0);function G(e,t){let r=g(S),o=g(y),n=e.clone({headers:e.headers.append("Authorization",`Bearer ${localStorage.getItem("token")||""}`)}),s=e.context.get(f)&&e.method!=="GET",w=e.context.get(L)&&e.method==="GET";return w&&o.toggleLoading(!0),s&&o.toggleUploading(!0),t(n).pipe(l(p=>(console.log(p),C(p,r),v(()=>p))),b(()=>{s&&o.toggleUploading(!1),w&&o.toggleLoading(!1)}))}var C=(e,t)=>{let r=typeof e.error.message=="string"?e.error.message:"Solicitud incorrecta";switch(e.status){case 500:t.show({severity:"error",title:"Ha ocurrido un error"});break;case 401:break;case 400:t.show({severity:"warn",title:"Solictud incorrecta",description:r});break;case 403:break;case 404:t.show({severity:"warn",title:"Solictud incorrecta",description:r});break;default:break}throw e};var E=class e{constructor(t){this.http=t}URL=R.apiUrl;_user=c(null);_menu=c([]);_roles=c([]);_updatedPassword=c(!1);user=i(()=>this._user());menu=i(()=>this._menu());roles=i(()=>this._roles());updatedPassword=i(()=>this._updatedPassword());profileLetter=i(()=>this._user()?.fullName.charAt(0)??"U");login(t,r,o=!1){return o?localStorage.setItem("login",t):localStorage.removeItem("login"),this.http.post(`${this.URL}/auth`,{login:t,password:r},{context:new _().set(f,!1)}).pipe(d(({token:n})=>this._setAuthentication(n)))}logout(){localStorage.removeItem("token"),this._user.set(null)}checkAuthStatus(){return localStorage.getItem("token")?this.http.get(`${this.URL}/auth`).pipe(h(r=>console.log(r)),d(({menu:r,token:o,updatedPassword:n,roles:s})=>(this._menu.set(r),this._roles.set(s),this._updatedPassword.set(n),this._setAuthentication(o))),l(()=>(console.log("REMOVERRRR"),this.logout(),u(!1)))):(this.logout(),u(!1))}updateMyUser(t){return this.http.put(`${this.URL}/auth`,{password:t}).pipe(h(()=>this._updatedPassword.set(!0)))}_setAuthentication(t){return this._user.set(U(t)),localStorage.setItem("token",t),!0}static \u0275fac=function(r){return new(r||e)(I(H))};static \u0275prov=k({token:e,factory:e.\u0275fac,providedIn:"root"})};export{G as a,E as b};
